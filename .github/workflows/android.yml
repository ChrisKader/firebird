name: Build for Android

on:
  push:
    branches: [ master, ci/android ]
  pull_request:
    branches: [ master, ci/android ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d
          add-to-path: false

      - name: Install Qt 6 host tools (Linux desktop)
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.7.3"
          host: linux
          target: desktop
          arch: gcc_64
          cache: true

      - name: Install Qt 6 (Android target)
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.7.3"
          host: linux
          target: android
          arch: android_arm64_v8a
          cache: true

      - name: Build APK (qmake)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          GRADLE_USER_HOME: ${{ github.workspace }}/.build/android/gradle-home
        run: |
          mkdir -p .build/android
          cd .build/android
          qmake ../../firebird.pro CONFIG+=release ANDROID_ABIS=arm64-v8a
          make -j"$(nproc)" apk_install_target

      - name: Pack APK
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          GRADLE_USER_HOME: ${{ github.workspace }}/.build/android/gradle-home
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEYSTORE_PWD: ${{ secrets.ANDROID_KEYSTORE_PWD }}
        run: |
          cd .build/android
          if [ -n "$ANDROID_KEYSTORE_PWD" ]; then
            echo "$ANDROID_KEYSTORE" | base64 -d > keystore.jks
            androiddeployqt \
              --android-platform android-34 \
              --input android-firebird-emu-deployment-settings.json \
              --output "$GITHUB_WORKSPACE/.build/android/android-build" \
              --apk firebird-emu.apk \
              --sign keystore.jks firebirdemugh \
              --storepass "$ANDROID_KEYSTORE_PWD"
          else
            androiddeployqt \
              --android-platform android-34 \
              --input android-firebird-emu-deployment-settings.json \
              --output "$GITHUB_WORKSPACE/.build/android/android-build" \
              --apk firebird-emu.apk
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: firebird-emu-android-arm64
          path: .build/android/firebird-emu.apk
          if-no-files-found: error
